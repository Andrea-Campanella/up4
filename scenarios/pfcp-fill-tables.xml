<!--
 ~ SPDX-License-Identifier: LicenseRef-ONF-Member-1.0
 ~ SPDX-FileCopyrightText: 2020-present Open Networking Foundation <info@opennetworking.org>
  -->
<scenario name="pfcp-fill-tables" description="Set up a bunch of UE sessions to fill the UPF">
    <group name="Pfcp-Fill-Tables">
        <group name="FT-Setup-Flows-1">
            <step name="FT-Create-Sessions-1"
                  exec="mock-smf-cmd create --session-count 32"/>
            <step name="FT-Modify-Sessions-1" requires="^" delay="10"
                  exec="mock-smf-cmd modify --session-count 32"/>
        </group>

        <step name="FT-Check-Flows-1" requires="FT-Setup-Flows-1" delay="5"
              exec="onos-cli-grep ${OCI} up4:read-flows '64 flows found'"/>
        <step name="FT-Check-Flows-2" requires="^"
              exec="onos-check-flows ${OCI}"/>

        <step name="FT-Delete-Sessions-1" requires="~^"
              exec="mock-smf-cmd delete --session-count 32"/>
        <step name="FT-Check-Flows-3" requires="^" delay="10"
              exec="onos-cli-grep ${OCI} up4:read-flows '0 flows found'"/>

        <group name="FT-Setup-Flows-2" requires="FT-Check-Flows-3">
            <step name="FT-Create-Sessions-2"
                  exec="mock-smf-cmd create --session-count 33"/>
        </group>

        <!-- Check that 32 of the 33 sessions have been installed, and the 33rd was rejected -->
        <step name="FT-Check-Flows-4" requires="FT-Setup-Flows-2" delay="5"
              exec="onos-cli-grep ${OCI} up4:read-flows '64 flows found'"/>
        <step name="FT-Check-Flows-5" requires="^"
              exec="onos-check-flows ${OCI}"/>
        <step name="FT-Check-Error-Response" requires="^"
              exec="file-grep tmp/mock-smf.log 'session_establishment_response: Request rejected'"/>

        <group name="FT-Clear-Flows" requires="~FT-Check-Error-Response">
            <step name="FT-Disassociate"
                  exec="mock-smf-cmd disassociate"/>
            <step name="FT-Check-Flows-6" requires="^" delay="5"
                  exec="onos-cli-grep ${OCI} up4:read-flows '0 flows found'"/>
            <step name="FT-Reassociate" requires="^"
                  exec="mock-smf-cmd associate"/>
        </group>

    </group>
</scenario>
